<!doctype html><html lang=en><head><title>使用 Travis CI 持续集成托管在 GitHub Pages 的 Hugo 博客 ::
三寸光阴 — 一寸光阴一寸金</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="将 Hugo 博客托管到 GitHub Pages 时，官方文档提供了使用 master 分支 /docs 文件夹发布和使用 gh-pages 分支发布两种方式。然而当设置 GitHub Pages 中的 source 选项时，你会发现: User pages must be built from the master branch."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/2020-03-29-publish-github-pages-by-hugo-and-travis-ci/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon.png><link href=/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="使用 Travis CI 持续集成托管在 GitHub Pages 的 Hugo 博客"><meta name=twitter:description content="将 Hugo 博客托管到 GitHub Pages 时，官方文档提供了使用 master 分支 /docs 文件夹发布和使用 gh-pages 分支发布两种方式。然而当设置 GitHub Pages 中的 source 选项时，你会发现: User pages must be built from the master branch."><meta property="og:title" content="使用 Travis CI 持续集成托管在 GitHub Pages 的 Hugo 博客"><meta property="og:description" content="将 Hugo 博客托管到 GitHub Pages 时，官方文档提供了使用 master 分支 /docs 文件夹发布和使用 gh-pages 分支发布两种方式。然而当设置 GitHub Pages 中的 source 选项时，你会发现: User pages must be built from the master branch."><meta property="og:type" content="article"><meta property="og:url" content="/posts/2020-03-29-publish-github-pages-by-hugo-and-travis-ci/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-29T22:25:58+08:00"><meta property="article:modified_time" content="2020-03-29T22:25:58+08:00"><meta property="og:site_name" content="三寸光阴"></head><body><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>三寸光阴</span>
<span class=logo__cursor></span></a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/archive>归档</a></li><li><a href=/about>关于</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/archive>归档</a></li><li><a href=/about>关于</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>使用 Travis CI 持续集成托管在 GitHub Pages 的 Hugo 博客</h1><div class=post-meta><span class=post-date>2020-03-29 22:25</span></div><span class=post-tags><a href=/tags/hugo/>#hugo</a>&nbsp;
<a href=/tags/blog/>#blog</a>&nbsp;
<a href=/tags/github-pages/>#github pages</a>&nbsp;
<a href=/tags/travis-ci/>#travis ci</a>&nbsp;</span><div class=post-content><h2>Table of Contents</h2><aside class=table-of-contents><nav id=TableOfContents><ul><li><a href=#准备工作>准备工作</a><ul><li><a href=#hugo-本地建站>Hugo 本地建站</a></li><li><a href=#github-pages>GitHub Pages</a></li></ul></li><li><a href=#使用-travis-ci-持续集成>使用 Travis CI 持续集成</a><ul><li><a href=#创建-blog-分支>创建 blog 分支</a></li><li><a href=#配置-travis-ci>配置 Travis CI</a></li><li><a href=#测试效果>测试效果</a></li></ul></li><li><a href=#工作流>工作流</a></li><li><a href=#踩坑记录>踩坑记录</a></li></ul></nav></aside><p>将 Hugo 博客托管到 GitHub Pages 时，官方文档提供了<a href=https://gohugo.io/hosting-and-deployment/hosting-on-github/#deployment-of-project-pages-from-docs-folder-on-master-branch target=_blank>使用 master 分支 /docs 文件夹发布</a>和<a href=https://gohugo.io/hosting-and-deployment/hosting-on-github/#deployment-of-project-pages-from-your-gh-pages-branch target=_blank>使用 gh-pages 分支发布</a>两种方式。然而当设置 GitHub Pages 中的 source 选项时，你会发现:</p><blockquote><p>User pages must be built from the master branch.</p></blockquote><p>GitHub Pages 现在已经不支持指定文件夹和修改分支了。有些教程提供了<a href=[https://medium.com/@chswei/%E5%9C%A8-github-%E9%83%A8%E7%BD%B2-hugo-%E9%9D%9C%E6%85%8B%E7%B6%B2%E7%AB%99-9c40682dfe40]%28https://medium.com/@chswei/%e5%9c%a8-github-%e9%83%a8%e7%bd%b2-hugo-%e9%9d%9c%e6%85%8b%e7%b6%b2%e7%ab%99-9c40682dfe40%29>建立两个 repo</a>或者<a href=https://brent-li.github.io/post/build-personal-site-with-hugo/ target=_blank>只发布 public 文件夹</a>的方案，然而第一种管理太过繁琐，第二种有丢失本地文件的风险。因此这里我们使用 Travis CI，在同一个项目内维护两个分支，实现 push 之后博客的自动发布。</p><h2 id=准备工作>准备工作</h2><h3 id=hugo-本地建站>Hugo 本地建站</h3><p>本文默认已经在本地搭建好了博客，并放在单独文件夹下，如 site-blog</p><h3 id=github-pages>GitHub Pages</h3><p>本文默认已经在 GitHub 建好了个人仓库。</p><h2 id=使用-travis-ci-持续集成>使用 Travis CI 持续集成</h2><h3 id=创建-blog-分支>创建 blog 分支</h3><ol><li><p>进入 GitHub Pages 项目(如 <code>isTianxin.github.io</code>)，在根目录创建一个新的分支 blog</p><blockquote><p>git checkout &ndash;orphan blog</p></blockquote></li><li><p>删除该分支内的所有文件(如果 GitHub Pages 项目之前生成了 CNAME, LISENCE等文件，这里需要保留)</p><blockquote><p>git rm rf .</p></blockquote></li><li><p>复制本地 Hugo 博客文件夹(如 site-blog )下的全部内容到当前文件夹下，若上一步有 CNAME，LISENCE 等文件，也要一起复制过来。</p></li><li><p>提交分支</p><blockquote><p>git add .</p><p>git commit -m &lsquo;init blog branch&rsquo;</p></blockquote></li></ol><h3 id=配置-travis-ci>配置 Travis CI</h3><ol><li><p>访问 <a href=https://travis-ci.org/ target=_blank>Travis CI</a>, 使用 GitHub 登陆并授权。</p></li><li><p>生成 <a href=https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line target=_blank>GitHub token</a>, 并在 Travis CI 里选择 GitHub Pages项目(如 <code>isTianXin.github.io</code>), <a href=https://docs.travis-ci.com/user/environment-variables#defining-variables-in-repository-settings target=_blank>添加环境变量</a><code>GITHUB_TOKEN</code>, 这个变量会在 <code>.travis.yml</code> 中使用，添加后的效果如图。</p><p><a data-fancybox=gallery href=https://tva1.sinaimg.cn/large/00831rSTgy1gdavq3atmgj322u0k241l.jpg><img src=https://tva1.sinaimg.cn/large/00831rSTgy1gdavq3atmgj322u0k241l.jpg alt=travis-env-var></a></p></li><li><p>在GitHub Pages 项目 blog 分支根目录下，编写并保存 <code>.travis.yml</code>,</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>language</span><span class=p>:</span><span class=w> </span><span class=l>go</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c>#指定 Go 版本</span><span class=w>
</span><span class=w></span><span class=nt>go</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=s2>&#34;1.13.1&#34;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># 仅在 blog 分支提交时触发持续集成</span><span class=w>
</span><span class=w></span><span class=nt>branches</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>only</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=l>blog</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># 安装 hugo</span><span class=w>
</span><span class=w></span><span class=nt>install</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>wget https://github.com/gohugoio/hugo/releases/download/v0.68.3/hugo_0.68.3_Linux-64bit.deb</span><span class=w>
</span><span class=w>    </span>- <span class=l>sudo dpkg -i hugo*.deb</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>script</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>hugo</span><span class=w> </span><span class=c>#编译</span><span class=w>
</span><span class=w>    </span>- <span class=l>cp CNAME LICENSE ./public</span><span class=w> </span><span class=c>#将CNAME等文件拷贝到public</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>deploy</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>provider</span><span class=p>:</span><span class=w> </span><span class=l>pages</span><span class=w>
</span><span class=w>    </span><span class=nt>skip_cleanup</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=nt>github_token</span><span class=p>:</span><span class=w> </span><span class=l>$GITHUB_TOKEN</span><span class=w>
</span><span class=w>    </span><span class=nt>keep_history</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=nt>target_branch</span><span class=p>:</span><span class=w> </span><span class=l>master</span><span class=w>
</span><span class=w>    </span><span class=nt>on</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>branch</span><span class=p>:</span><span class=w> </span><span class=l>blog</span><span class=w>
</span><span class=w>    </span><span class=nt>local_dir</span><span class=p>:</span><span class=w> </span><span class=l>public</span><span class=w>
</span></code></pre></div><p>该配置的作用是在 push 到 blog 分支后，会自动编译并将 public 文件夹下的内容发布到 master 分支，从而实现博客的持续集成。</p></li><li><p>推送 blog 分支到 GitHub</p><blockquote><p>git add .</p><p>git push origin HEAD</p></blockquote></li></ol><h3 id=测试效果>测试效果</h3><p>在 GitHub Pages 项目 blog 分支下创建一篇博文并 push 到 GitHub，如:</p><blockquote><p>huho new posts/test.md</p><p>git add .</p><p>git commit -m &lsquo;添加测试博文&rsquo;</p><p>git push origin blog</p></blockquote><p>打开 Travis CI, 找到对应的项目，当看到 passed, 就代表集成成功，打开博客网站去查看效果吧。</p><p><a data-fancybox=gallery href=https://tva1.sinaimg.cn/large/00831rSTgy1gdavp6w0hjj31yo0o6tdj.jpg><img src=https://tva1.sinaimg.cn/large/00831rSTgy1gdavp6w0hjj31yo0o6tdj.jpg alt=travis-job></a></p><h2 id=工作流>工作流</h2><p>添加 Travis CI 之后，只需要将新添加的 Markdown 文件 push 到 blog 分支，即可自动发布到博客网站。</p><h2 id=踩坑记录>踩坑记录</h2><ul><li><p>Travis CI 提供的 Ubuntu 包管理 apt 内的 hugo 版本过低，直接使用 <code>sudo apt install hugo</code> 安装，在编译时会得到如下报错:</p><blockquote><p>Current theme does not support Hugo version 0.16. Minimum version required is 0.43</p></blockquote><p>因此这里直接下载 GitHub release 包进行安装。</p></li><li><p>如果你的 GitHub Pages 使用了自定义域名，请 <strong><i>务必</i></strong>将 CNAME 文件拷贝到 public 目录下，即:</p><blockquote><p>cp CNAME LICENSE ./public</p></blockquote><p>否则使用自定义域名无法访问博客。</p></li></ul></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>阅读更多</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/2020-12-01-confession/><span class=button__icon>←</span>
<span class=button__text>供词</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>三寸光阴</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2021
<a style=text-decoration:none href=https://beian.miit.gov.cn/ target=_blank rel=noopener>鲁ICP备2021021411号-1</a></span>
<span><img src=/img/20210630/beian.png style=float:left;padding-right:4px>
<a style=text-decoration:none href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=37011602000031" target=_blank rel=noopener>鲁公网安备37011602000031号</a></span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script></div></body></html>